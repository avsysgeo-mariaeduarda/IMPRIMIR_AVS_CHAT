<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IMPRIMIR CONVERSA</title>
</head>
<body>

<script src="https://fileschat.sfo2.cdn.digitaloceanspaces.com/public/libs/wlclient.js"></script>

<script>
  const API_BASE = 'https://api.avschat.com.br/core/v2/api';
  const API_SCRIPTS = 'https://api.avschat.com.br/core/v2/api/scripts/delaied';

  const SCRIPT_HOJE    = '697ba2909e27ed3154f13698';
  const SCRIPT_PERIODO = '697d0409f45542f5cf863707';

  const KEY_DATA_IMPRIMIR = 'data_imprimir';

  function extractIds(atendimento) {
    return {
      chatId:
        atendimento?.chat?.codigo ||
        atendimento?.attendanceId ||
        atendimento?.id ||
        null,

      contactId:
        atendimento?.contato?.codigo ||
        atendimento?.contact?.id ||
        null,

      token:
        atendimento?.canal?.token ||
        atendimento?.channel?.token ||
        atendimento?.token ||
        null
    };
  }

  function headers(token) {
    return {
      "access-token": token,
      "Content-Type": "application/json",
      "Accept": "application/json"
    };
  }

  async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    const txt = await res.text().catch(() => "");
    if (!res.ok) throw new Error(txt || res.status);
    if (!txt.trim()) return {};
    try { return JSON.parse(txt); } catch { return {}; }
  }

  async function setDataImprimir(contactId, hdrs, value) {
    return fetchJSON(`${API_BASE}/contacts/${contactId}/set-attributes`, {
      method: "POST",
      headers: hdrs,
      body: JSON.stringify([
        {
          key: KEY_DATA_IMPRIMIR,
          value,
          description: "IMPRIMIR"
        }
      ])
    });
  }

  async function executaScript(scriptId, hdrs) {
    return fetchJSON(API_SCRIPTS, {
      method: "POST",
      headers: hdrs,
      body: JSON.stringify({
        description: "IMPRIMIR CONVERSA",
        scriptId,
        amountDelay: 3,
        typeDelay: 0,
        context: {
          channelId: "@canal.token",
          organizationId: "@empresa.codigo",
          attendanceId: "@chat.codigo",
          contactId: "@contato.codigo",
          userId: "@usuario.codigo",
          sectorId: "@setor.codigo",
          variablesContext: []
        }
      })
    });
  }


  function abrirMenuImprimir(atendimento) {
    const ids = extractIds(atendimento);

    if (!ids.chatId || !ids.contactId || !ids.token) {
      return window.WlExtension.alert({
        message: "Não foi possível identificar chat, contato ou token.",
        variant: "error"
      });
    }

    const hdrs = headers(ids.token);

    window.WlExtension.confirmDialog({
      title: "IMPRIMIR CONVERSA",
      text:
        "Selecione o tipo de impressão:\n\n" +
        "[ 1 ] HOJE\n" +
        "[ 2 ] DO DIA\n" +
        "[ 3 ] PERÍODO",
      callback: async (ok) => {
        if (!ok) return;

        const opcao = String(prompt("Digite 1, 2 ou 3:", "1") || "").trim();

        try {

          if (opcao === "1") {
            const value = `CHATID=${ids.chatId};TIPO=HOJE`;

            await setDataImprimir(ids.contactId, hdrs, value);
            await executaScript(SCRIPT_HOJE, hdrs);

            return window.WlExtension.alert({
              message: "IMPRIMIR (HOJE) enviado.",
              variant: "success"
            });
          }

          if (opcao === "2") {
            const dia = prompt("Informe a data (00/00/0000):", "00/00/0000");

            const value =
              `CHATID=${ids.chatId};TIPO=DIA;DATA=${String(dia || "")}`;

            await setDataImprimir(ids.contactId, hdrs, value);
            await executaScript(SCRIPT_PERIODO, hdrs);

            return window.WlExtension.alert({
              message: "IMPRIMIR (DO DIA) enviado.",
              variant: "success"
            });
          }

          if (opcao === "3") {
            const de  = prompt("Do dia (00/00/0000):", "00/00/0000");
            const ate = prompt("Até dia (00/00/0000):", "00/00/0000");

            const value =
              `CHATID=${ids.chatId};TIPO=PERIODO;DE=${String(de || "")};ATE=${String(ate || "")}`;

            await setDataImprimir(ids.contactId, hdrs, value);
            await executaScript(SCRIPT_PERIODO, hdrs);

            return window.WlExtension.alert({
              message: "IMPRIMIR (PERÍODO) enviado.",
              variant: "success"
            });
          }

          return window.WlExtension.alert({
            message: "Opção inválida.",
            variant: "error"
          });

        } catch (e) {
          console.error(e);
          return window.WlExtension.alert({
            message: "Erro ao enviar solicitação.",
            variant: "error"
          });
        }
      }
    });
  }

  window.WlExtension.initialize({
    buttons: {
      "attendance-view": [
        {
          icon_url: "https://img.icons8.com/material-sharp/15/000000/print.png",
          text: "IMPRIMIR CONVERSA",
          callback: abrirMenuImprimir
        }
      ]
    }
  });
</script>

</body>
</html>
