<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IMPRIMIR</title>
</head>
<body>

<script src="https://fileschat.sfo2.cdn.digitaloceanspaces.com/public/libs/wlclient.js"></script>

<script>
catch (_) { return null; }
  }

function renderModal() {
  document.body.innerHTML = `
    <style>
  body {
    font-family: Arial, Helvetica, sans-serif;
  }

  .container {
    padding: 12px 16px;
  }

  .actions {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  button {
    padding: 6px 14px;
    cursor: pointer;
    background-color: #192d3e;
    color: #ffffff;
    border: none;
    border-radius: 4px;
    font-size: 13px;
  }

  .box {
    margin-top: 12px;
  }

  .row {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .col {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  input {
    padding: 6px;
    width: 110px;
  }

  .msg {
    margin-top: 6px;
    color: #b00020;
    font-size: 12px;
  }
</style>

    <div class="container">
      <div class="actions">
        <button id="btn-hoje">HOJE</button>
        <button id="btn-anteriores">DIAS ANTERIORES</button>
      </div>

      <div id="box-hoje" class="box" style="display:none;">
        <p>Ao prosseguir, será impresso o histórico da conversa de hoje.</p> 
        <div class="row">
          <button id="btn-confirmar-hoje">CONFIRMAR</button>
          <button id="btn-cancelar-hoje">CANCELAR</button>
        </div>
      </div>

      <div id="box-data" class="box" style="display:none;">        
        <p>Insira dia escolhido (DD/MM/AA)</p>   
        <div>                     
          <input id="inp-data" placeholder="00/00/00" maxlength="8">   
          <input id="inp-data-antiga" placeholder="00/00/00" maxlength="8">    
        </div>     
        <div class="row">
          <button id="btn-enviar">CONFIRMAR</button>
          <button id="btn-cancelar">CANCELAR</button>
        </div>
        <div id="msg" class="msg"></div>
      </div>
    </div>
  `;

    const btnHoje = document.getElementById("btn-hoje");
    const btnAnt = document.getElementById("btn-anteriores");

    const boxHoje = document.getElementById("box-hoje");

    function setMsg(t) { if (msgEl) msgEl.textContent = t || ""; }

    function closeCancel() {
      window.WlExtension.closeModal({ cancelled: true });
    }

    function normalizeDDMMAA(v) {
    
      let s = String(v || "").replace(/[^\d]/g, "").slice(0, 6);
      if (s.length > 2) s = s.slice(0,2) + "/" + s.slice(2);
      if (s.length > 5) s = s.slice(0,5) + "/" + s.slice(5);

      const yyyy = 2000 + aa;

      const d = new Date(yyyy, mm - 1, dd);
      const ok =
        d.getFullYear() === yyyy &&
        d.getMonth() === (mm - 1) &&
        d.getDate() === dd;

      if (!ok) return { ok:false, error:"Data inválida." };

      return { ok:true, short:`${m[1]}/${m[2]}/${m[3]}`, full:`${m[1]}/${m[2]}/${yyyy}` };

      setMsg("");
    });
 
    btnHoje.onclick = () => {
      boxData.style.display = "none";
      boxHoje.style.display = "block";

    };
  
    btnAnt.onclick = () => {
      boxHoje.style.display = "none";
      boxData.style.display = "block";
      setTimeout(() => inpData.focus(), 10);

    };

    document.getElementById("btn-cancelar").onclick = closeCancel;

    document.getElementById("btn-enviar").onclick = () => {
      const p = parseDDMMAA(inpData.value);
      if (!p.ok) {
        setMsg(p.error);
        return;
      }
      window.WlExtension.closeModal({
        action: "anteriores",
        data: p.short,   
        dataFull: p.full 
      });
    };
  }

  window.WlExtension.initialize({
  buttons: {
    "attendance-view": [
      {
        icon_url: "https://img.icons8.com/material-sharp/15/000000/print.png",
        text: "IMPRIMIR",
        callback: (atendimento) => {

          const modalUrl = "https://avsystemgeo-avs.github.io/AVSCHAT-PRINT-GERAL/?mode=modal";

          window.WlExtension.modal({
            title: "IMPRIMIR",
            url: modalUrl,
            maxWidth: "450px",
            height: "280px",
            callback: (ret) => {
              if (!ret || ret.cancelled) return;

              if (ret.action === "hoje") {
                window.WlExtension.alert({
                  message: "Selecionado: HOJE",
                  variant: "success"
                });
              }

              if (ret.action === "anteriores") {
                window.WlExtension.alert({
                  message: `Selecionado: DIAS ANTERIORES (${ret.data})`,
                  variant: "success"
                });
              }
            }
          });
        }
      }
    ]
  }
});


  if (getParam("mode") === "modal") renderModal();
  else initExtension();
</script>

</body>
</html>
