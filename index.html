<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IMPRIMIR</title>
</head>
<body>

<script src="https://fileschat.sfo2.cdn.digitaloceanspaces.com/public/libs/wlclient.js"></script>

<script>

function getParam(name) {
  try {
    return new URL(window.location.href).searchParams.get(name);
  } catch (_) {
    return null;
  }
}

function renderModal() {
  document.body.innerHTML = `
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        color: #000;
      }
      
      .container{
        padding: 16px;
        width: 100%;
        max-width: 350px;
        margin: 0 auto; 
      }
      
      .actions {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        justify-content: flex-start;
      }

      button {
        padding: 8px 16px;
        width: 160px;
        cursor: pointer;
        background-color: #192d3e;
        color: #ffffff;
        border: none;
        border-radius: 6px;
        font-size: 14px;
      }

      .box {
        margin-top: 16px;
      }

      .row {
        display: flex;
        gap: 16px;
        margin-top: 16px;
        justify-content: flex-start;
      }

      input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #000;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
        margin-bottom: 12px;
      }

      input:focus {
        outline: none;
        border-color: #192d3e;
        box-shadow: 0 0 0 2px rgba(25, 45, 62, 0.15);
      }
      
      .msg {
        margin-top: 8px;
        color: #b00020;
        font-size: 13px;
      }
    </style>

    <div class="container">

      <div class="actions">
        <button id="btn-hoje" type="button">HOJE</button>
        <button id="btn-anteriores" type="button">DIAS ANTERIORES</button>
      </div>

      <div id="box-hoje" class="box" style="display:none;">
        <p>Será impresso o histórico de hoje.</p>
        <div class="row">
          <button id="btn-confirmar-hoje" type="button">CONFIRMAR</button>
          <button id="btn-cancelar-hoje" type="button">CANCELAR</button>
        </div>
      </div>

      <div id="box-data" class="box" style="display:none;">

          <p>Insira dia escolhido (DD/MM/AA)</p>
          <input id="inp-data" placeholder="00/00/00" maxlength="8">

        <div class="row">
          <button id="btn-enviar" type="button">CONFIRMAR</button>
          <button id="btn-cancelar" type="button">CANCELAR</button>
        </div>

        <div id="msg" class="msg"></div>
      </div>

    </div>
  `;

  const btnHoje = document.getElementById("btn-hoje");
  const btnAnt = document.getElementById("btn-anteriores");
  const boxHoje = document.getElementById("box-hoje");
  const boxData = document.getElementById("box-data");
  const inpData = document.getElementById("inp-data");
  const msgEl = document.getElementById("msg");

  function setMsg(t) {
    msgEl.textContent = t || "";
  }

  function closeCancel() {
    window.WlExtension.closeModal({ cancelled: true });
  }

  function normalizeDDMMAA(v) {
    let s = String(v || "").replace(/[^\d]/g, "").slice(0, 6);
    if (s.length > 2) s = s.slice(0,2) + "/" + s.slice(2);
    if (s.length > 5) s = s.slice(0,5) + "/" + s.slice(5);
    return s;
  }

  function parseDDMMAA(v) {
    const m = String(v || "").match(/^(\d{2})\/(\d{2})\/(\d{2})$/);
    if (!m) return { ok:false, error:"Use 00/00/00 (DD/MM/AA)" };

    const dd = +m[1], mm = +m[2], aa = +m[3];
    const yyyy = 2000 + aa;
    const d = new Date(yyyy, mm - 1, dd);

    if (
      d.getFullYear() !== yyyy ||
      d.getMonth() !== mm - 1 ||
      d.getDate() !== dd
    ) {
      return { ok:false, error:"Data inválida" };
    }

    return { ok:true, data:`${m[1]}/${m[2]}/${m[3]}` };
  }

  btnHoje.onclick = () => {
    boxData.style.display = "none";
    boxHoje.style.display = "block";
  };

  btnAnt.onclick = () => {
    boxHoje.style.display = "none";
    boxData.style.display = "block";
    setTimeout(() => inpData.focus(), 50);
  };

  inpData.addEventListener("input", () => {
    inpData.value = normalizeDDMMAA(inpData.value);
    setMsg("");
  });

  document.getElementById("btn-cancelar").onclick = closeCancel;
  document.getElementById("btn-cancelar-hoje").onclick = closeCancel;

  document.getElementById("btn-confirmar-hoje").onclick = () => {
    window.WlExtension.closeModal({ action: "hoje" });
  };

  document.getElementById("btn-enviar").onclick = () => {
    const p = parseDDMMAA(inpData.value);
    if (!p.ok) return setMsg(p.error);

    window.WlExtension.closeModal({
      action: "anteriores",
      data: p.data
    });
  };
}

function initExtension() {
  window.WlExtension.initialize({
    buttons: {
      "attendance-view": [
        {
          icon_url: "https://img.icons8.com/material-sharp/15/000000/print.png",
          text: "IMPRIMIR",
          callback: () => {

            const modalUrl =
              "https://avsysgeo-mariaeduarda.github.io/IMPRIMIR_AVS_CHAT/?mode=modal";

            window.WlExtension.modal({
              title: "IMPRIMIR",
              url: modalUrl,
              maxWidth: "450px",
              height: "280px",
              callback: (ret) => {
                if (!ret || ret.cancelled) return;

                // Aqui depois vou ligar
                if (ret.action === "hoje") {
                  window.WlExtension.alert({
                    message: "Selecionado: HOJE",
                    variant: "success"
                  });
                }

                if (ret.action === "anteriores") {
                  window.WlExtension.alert({
                    message: "Selecionado: " + ret.data,
                    variant: "success"
                  });
                }
              }
            });
          }
        }
      ]
    }
  });
}


if (getParam("mode") === "modal") {
  renderModal();
} else {
  initExtension();
}
</script>

</body>
</html>
